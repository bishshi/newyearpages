<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é©¬å¹´æ–°æ˜¥å¼¹å¹•</title>
    <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js"></script>
    <style>
        /* --- 1. å…¨å±€æ ·å¼ --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #800000 0%, #A52A2A 50%, #FF4500 100%);
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 2. èƒŒæ™¯æ–‡å­— --- */
        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 0;
            pointer-events: none;
        }

        .bg-text {
            font-size: 18vw;
            font-weight: 900;
            color: rgba(255, 215, 0, 0.08); /* æ·¡é‡‘è‰²èƒŒæ™¯å­— */
            font-family: 'KaiTi', 'STKaiti', serif;
            user-select: none;
            text-align: center;
            line-height: 1.2;
        }

        /* --- 3. å¼¹å¹•èˆå° --- */
        .danmaku-stage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            transform: translateZ(0); /* å¼€å¯GPUåŠ é€Ÿ */
        }

        /* --- 4. å¼¹å¹•æœ¬ä½“ --- */
        .danmaku-item {
            position: absolute;
            left: 100%; /* åˆå§‹ä½ç½®åœ¨å±å¹•å¤– */
            white-space: nowrap;
            color: #fff; /* é»˜è®¤ç™½è‰² */
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            will-change: transform;
            transition: color 0.3s, transform 0.2s;
        }

        /* ã€æ ·å¼ä¿®æ”¹ã€‘é«˜èµï¼šçº¯é‡‘å­—ï¼Œæ— è¾¹æ¡† */
        .danmaku-item.super-hot {
            color: #FFD700 !important;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            z-index: 20;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes flyLeft {
            from { transform: translateX(0); }
            to { transform: translateX(-150vw); } /* ç¡®ä¿å®Œå…¨ç§»å‡º */
        }

        /* äº¤äº’æ ¸å¿ƒï¼šæ‚¬åœ/ç‚¹å‡»æ—¶æš‚åœåŠ¨ç”» */
        .danmaku-item:hover,
        .danmaku-item:active {
            z-index: 100 !important;
            animation-play-state: paused !important; /* CSSæš‚åœå¤§æ³• */
            filter: brightness(1.1);
        }

        /* --- 5. è¯¦æƒ…å°é»‘æ¡† --- */
        .dm-info {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            top: 100%;
            margin-top: 4px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 13px;
            color: #fff;
            text-shadow: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(5px);
            transition: all 0.2s;
            pointer-events: auto;
            min-width: 130px;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .danmaku-item:hover .dm-info {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* é«˜èµå¼¹å¹•çš„è¯¦æƒ…æ¡†ä¹Ÿå¸¦ç‚¹é‡‘è‰² */
        .danmaku-item.super-hot .dm-info {
            border-color: rgba(255, 215, 0, 0.4);
        }

        .nick-name {
            color: #ddd;
            font-size: 12px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .danmaku-item.super-hot .nick-name {
            color: #FFD700;
        }

        .like-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: #fff;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .like-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .like-btn.liked {
            color: #FFD700;
            border-color: #FFD700;
        }

        /* --- 6. åº•éƒ¨çŠ¶æ€æ  --- */
        .control-panel {
            position: absolute;
            bottom: 15px;
            right: 20px;
            z-index: 200;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            text-align: right;
            line-height: 1.6;
        }
    </style>
</head>
<body>

    <div class="bg-layer">
        <div class="bg-text">é©¬åˆ°<br>æˆåŠŸ</div>
    </div>

    <div id="danmaku-stage" class="danmaku-stage"></div>
    
    <div class="control-panel">
        <div>æ‚¬åœæˆ–ç‚¹å‡»å¼¹å¹•å¯ç‚¹èµ</div>
        <div id="status-text">è¿æ¥ä¸­...</div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const CONFIG = {
            // 1. Twikoo ç¯å¢ƒ ID
            twikooEnvId: 'https://comment.biss.click', 
            
            // 2. ã€å…³é”®ã€‘æŒ‡å®šé‡‡é›†é¡µé¢çš„è·¯å¾„
            // å¦‚æœä½ åœ¨ https://blog.com/2025/wishing/ åˆå§‹åŒ–äº†è¯„è®ºåŒº
            // è¿™é‡Œå°±å¡« '/2025/wishing/'ã€‚ç•™ç©º '' åˆ™é‡‡é›†å…¨ç«™ã€‚
            targetPath: '2026-greeting', 

            // 3. è§†è§‰ä¸è½¨é“
            baseSize: 22,       // åŸºç¡€å­—å·
            maxSize: 60,        // æœ€å¤§å­—å·
            trackHeight: 65,    // è½¨é“é«˜åº¦ (px)ï¼Œéœ€å¤§äºæœ€å¤§å­—å·é˜²æ­¢é‡å 
            
            // 4. é€Ÿåº¦ (åƒç´ /ç§’)
            minSpeed: 100,      // æ…¢
            maxSpeed: 180,      // å¿«
            
            // 5. é«˜èµé˜ˆå€¼ (å˜æˆé‡‘è‰²)
            hotThreshold: 10
        };

        const FALLBACK_DATA = [
            { text: "é©¬å¹´å¤§å‰ï¼", nick: "ç³»ç»Ÿ", like: 88 },
            { text: "èº«ä½“å¥åº·ï¼Œä¸‡äº‹å¦‚æ„", nick: "ç¦æ˜Ÿ", like: 66 },
            { text: "è´¢æºå¹¿è¿›", nick: "è´¢ç¥", like: 128 },
            { text: "ä»£ç  0 Error", nick: "Dev", like: 1024 },
            { text: "é¾™é©¬ç²¾ç¥", nick: "æˆè¯­å›", like: 20 },
            { text: "è®¸æ„¿æ˜å¹´æš´å¯Œ", nick: "é”¦é²¤", like: 9 },
            { text: "æ–°å¹´å¿«ä¹", nick: "Twikoo", like: 45 }
        ];

        let danmakuPool = [];
        let syncTimers = {}; // é˜²æŠ–è®¡æ—¶å™¨
        let tracks = [];     // è½¨é“å ç”¨çŠ¶æ€

        // --- åˆå§‹åŒ–è½¨é“ ---
        function initTracks() {
            const h = window.innerHeight;
            const count = Math.floor(h / CONFIG.trackHeight);
            tracks = new Array(count).fill(0); // å­˜çš„æ˜¯â€œè¯¥è½¨é“ä½•æ—¶å˜ç©ºé—²â€çš„æ—¶é—´æˆ³
        }
        window.onresize = initTracks;

        // --- 1. è·å–æ•°æ® ---
        async function initData() {
            initTracks();
            let items = [];
            const statusEl = document.getElementById('status-text');

            try {
                if (CONFIG.twikooEnvId !== 'YOUR_ENV_ID_HERE') {
                    // æ„å»ºæŸ¥è¯¢å‚æ•°
                    const params = {
                        envId: CONFIG.twikooEnvId,
                        pageSize: 80,
                        includeReply: false
                    };
                    // å¦‚æœæŒ‡å®šäº†è·¯å¾„ï¼Œæ·»åŠ è¿‡æ»¤
                    if (CONFIG.targetPath) {
                        params.urls = [CONFIG.targetPath];
                    }

                    const res = await twikoo.getRecentComments(params);
                    
                    items = res.map(item => ({
                        id: item._id,
                        text: item.commentText.replace(/<[^>]+>/g, "").trim().substring(0, 35),
                        nick: item.nick || "ç½‘å‹",
                        like: item.vote || item.like || 0
                    })).filter(i => i.text);

                    statusEl.innerText = `å·²åŠ è½½ ${items.length} æ¡è¯„è®º`;
                }
            } catch (e) {
                console.log("ç¦»çº¿æ¨¡å¼", e);
                statusEl.innerText = "ç¦»çº¿æ¼”ç¤ºæ¨¡å¼";
            }

            // å¡«å……ä¸è¶³çš„æ•°æ®
            if (items.length < 30) {
                while (items.length < 30) {
                    const fb = FALLBACK_DATA[Math.floor(Math.random() * FALLBACK_DATA.length)];
                    items.push({ ...fb, id: null, like: Math.floor(Math.random() * 50) });
                }
            }
            danmakuPool = items;
            startLoop();
        }

        // --- 2. åˆ›å»ºå¼¹å¹• (æ ¸å¿ƒé˜²é‡å é€»è¾‘) ---
        function createDanmaku() {
            const stage = document.getElementById('danmaku-stage');
            if (!danmakuPool.length) return;

            // A. å¯»æ‰¾ç©ºé—²è½¨é“
            const now = Date.now();
            const validTracks = tracks
                .map((t, i) => ({ idx: i, freeTime: t }))
                .filter(item => now >= item.freeTime); // å½“å‰æ—¶é—´ > è§£é”æ—¶é—´

            if (validTracks.length === 0) return; // å…¨å¿™ï¼Œä¸‹æ¬¡ä¸€å®š

            // éšæœºé€‰ä¸€ä¸ªç©ºè½¨é“
            const trackObj = validTracks[Math.floor(Math.random() * validTracks.length)];
            const trackIdx = trackObj.idx;

            // B. å‡†å¤‡æ•°æ®
            const data = danmakuPool[Math.floor(Math.random() * danmakuPool.length)];
            
            // å­—å·è®¡ç®—
            let fontSize = CONFIG.baseSize + (data.like / 4);
            if (fontSize > CONFIG.maxSize) fontSize = CONFIG.maxSize;

            // C. åˆ›å»º DOM
            const el = document.createElement('div');
            el.className = 'danmaku-item';
            if (data.like >= CONFIG.hotThreshold) el.classList.add('super-hot');

            el.style.fontSize = `${fontSize}px`;
            el.style.top = `${trackIdx * CONFIG.trackHeight + 10}px`; // ç»å¯¹å®šä½è½¨é“

            el.innerHTML = `
                <span class="dm-text">${data.text}</span>
                <div class="dm-info">
                    <span class="nick-name">@${data.nick}</span>
                    <button class="like-btn">ğŸ‘ <span class="count">${data.like}</span></button>
                </div>
            `;
            stage.appendChild(el); // å…ˆæ’å…¥ï¼Œä¸ºäº†ç®—å®½åº¦

            // D. è®¡ç®—è¿åŠ¨å‚æ•°
            const elWidth = el.offsetWidth;
            const screenW = window.innerWidth;
            const speed = Math.random() * (CONFIG.maxSpeed - CONFIG.minSpeed) + CONFIG.minSpeed;
            
            // æ€»è·¯ç¨‹ = å±å¹•å®½ + è‡ªèº«å®½ + ç¨å¾®å¤šè·‘ç‚¹(50px)
            const distance = screenW + elWidth + 50;
            const duration = distance / speed; // ç§’

            // è®¾ç½® CSS åŠ¨ç”»
            el.style.animation = `flyLeft ${duration}s linear forwards`;
            
            // åŠ¨ç”»ç»“æŸæ¸…ç†
            el.addEventListener('animationend', () => el.remove());

            // E. é”å®šè½¨é“
            // è½¨é“è§£é”æ—¶é—´ = ç°åœ¨ + (è‡ªèº«å®½åº¦ + é—´è·) / é€Ÿåº¦
            // è¿™æ ·åªæœ‰å½“å±è‚¡å®Œå…¨ç¦»å¼€èµ·è·‘çº¿ï¼Œä¸‹ä¸€è¾†è½¦æ‰èƒ½è¿›è¿™ä¸ªèµ›é“
            const safeGap = 60; // é—´è· px
            const timeToEnter = ((elWidth + safeGap) / speed) * 1000;
            tracks[trackIdx] = now + timeToEnter;

            // F. ç»‘å®šäº¤äº’
            const likeBtn = el.querySelector('.like-btn');
            el.querySelector('.dm-info').addEventListener('click', e => e.stopPropagation());

            likeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                data.like++;
                likeBtn.querySelector('.count').innerText = data.like;
                likeBtn.classList.add('liked');
                
                // å®æ—¶å˜é‡‘
                if (data.like >= CONFIG.hotThreshold) el.classList.add('super-hot');

                // åªæœ‰çœŸå®IDæ‰åŒæ­¥
                if (data.id) syncLike(data.id);
            });
        }

        // --- 3. é˜²æŠ–åŒæ­¥ ---
        function syncLike(cid) {
            if (syncTimers[cid]) clearTimeout(syncTimers[cid]);
            syncTimers[cid] = setTimeout(async () => {
                try {
                    await twikoo.linkComment({ id: cid, envId: CONFIG.twikooEnvId });
                    console.log('åŒæ­¥æˆåŠŸ:', cid);
                } catch (e) {
                    console.error('åŒæ­¥å¤±è´¥:', e);
                }
                delete syncTimers[cid];
            }, 2000); // 2ç§’æ— æ“ä½œåä¸Šä¼ 
        }

        function startLoop() {
            // å¼€å±€çˆ†å‘
            for(let i=0; i<8; i++) setTimeout(createDanmaku, i * 200);
            
            setInterval(() => {
                if (!document.hidden) createDanmaku();
            }, 500); // å‘å°„é¢‘ç‡åŠ å¿«ä¸€ç‚¹ï¼Œå› ä¸ºæœ‰è½¨é“æ£€æµ‹ï¼Œä¸ç”¨æ‹…å¿ƒé‡å 
        }

        window.onload = initData;

    </script>
</body>
</html>