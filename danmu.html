<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é©¬å¹´æ–°æ˜¥å¼¹å¹•å¢™</title>
    <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js"></script>
    <style>
        /* ================== 1. åŸºç¡€å¸ƒå±€ä¸èƒŒæ™¯ ================== */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #800000 0%, #A52A2A 50%, #FF4500 100%);
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 0;
            pointer-events: none;
        }

        .bg-text {
            font-size: 18vw;
            font-weight: 900;
            color: rgba(255, 215, 0, 0.08); /* æ·¡é‡‘æ°´å° */
            font-family: 'KaiTi', 'STKaiti', serif;
            user-select: none;
            text-align: center;
            line-height: 1.2;
        }

        /* ================== 2. å¼¹å¹•æ ¸å¿ƒæ ·å¼ ================== */
        .danmaku-stage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            transform: translateZ(0); /* å¼€å¯ç¡¬ä»¶åŠ é€Ÿ */
        }

        .danmaku-item {
            position: absolute;
            left: 100%; /* åˆå§‹åœ¨å±å¹•å³ä¾§å¤– */
            white-space: nowrap;
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            will-change: transform;
            transition: color 0.3s, transform 0.2s;
        }

        /* é«˜èµé‡‘è‰²ç‰¹æ•ˆ */
        .danmaku-item.super-hot {
            color: #FFD700 !important;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            z-index: 20;
        }

        /* åˆšå‘é€çš„æ–°å¼¹å¹•é«˜äº® */
        .danmaku-item.just-now {
            border: 1px solid rgba(255, 255, 255, 0.8);
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            padding: 0 5px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes flyLeft {
            from { transform: translateX(0); }
            to { transform: translateX(-150vw); } /* ç¡®ä¿å®Œå…¨ç§»å‡ºå·¦ä¾§ */
        }

        /* æ‚¬åœæš‚åœ */
        .danmaku-item:hover,
        .danmaku-item:active {
            z-index: 100 !important;
            animation-play-state: paused !important;
            filter: brightness(1.1);
        }

        /* ================== 3. è¯¦æƒ…å¡ç‰‡æ ·å¼ ================== */
        .dm-info {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            top: 100%;
            margin-top: 4px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 13px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(5px);
            transition: all 0.2s;
            pointer-events: auto;
            min-width: 130px;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .danmaku-item:hover .dm-info {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nick-name {
            color: #ddd;
            font-size: 12px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .like-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: #fff;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-btn.liked { color: #FFD700; border-color: #FFD700; }

        /* ================== 4. UI æ§ä»¶ ================== */
        /* å‘é€æŒ‰é’® */
        .send-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            background: linear-gradient(to bottom, #FFD700, #FFA500);
            border: 2px solid #B8860B;
            padding: 12px 35px;
            border-radius: 50px;
            color: #8B0000;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:active { transform: translateX(-50%) scale(0.95); }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .control-panel {
            position: absolute;
            bottom: 10px;
            right: 15px;
            z-index: 200;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            text-align: right;
            pointer-events: none;
        }

        /* ================== 5. åº•éƒ¨æŠ½å±‰ (Modal Sheet) - ã€å·²ä¿®æ”¹å®½åº¦é™åˆ¶ã€‘ ================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 900;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-sheet {
            position: fixed;
            bottom: 0;
            left: 50%; /* 1. ä»ä¸­å¿ƒå®šä½ */
            width: 100%;
            max-width: 640px; /* 2. ã€å…³é”®ã€‘é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé¿å…ç”µè„‘ä¸Šå¤ªå®½ */
            height: 75vh;
            background: #fff;
            z-index: 999;
            border-radius: 20px 20px 0 0;
            
            /* 3. ä½¿ç”¨ translate(-50%, ...) å®ç°å±…ä¸­ */
            transform: translate(-50%, 100%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        }
        
        /* æ¿€æ´»çŠ¶æ€ï¼šå‘ä¸Šæ»‘å‡ºï¼ŒåŒæ—¶ä¿æŒæ°´å¹³å±…ä¸­ */
        .modal-sheet.active { 
            transform: translate(-50%, 0); 
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        .modal-title { font-size: 18px; font-weight: bold; color: #333; }
        .close-btn { font-size: 24px; color: #999; cursor: pointer; padding: 0 10px; }

        .twikoo-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px 50px 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Twikoo æ ·å¼å¾®è°ƒ */
        #tcomment { --twikoo-theme-color: #d32f2f; }
        .tk-meta-input { background: #f5f5f5 !important; }
    </style>
    <!-- Matomo -->
    <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
        var u="//statistic.biss.click/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '2']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
    </script>
    <!-- End Matomo Code -->
</head>
<body>

    <div class="bg-layer">
        <div class="bg-text">é©¬åˆ°<br>æˆåŠŸ</div>
    </div>

    <div id="danmaku-stage" class="danmaku-stage"></div>
    
    <button class="send-btn" onclick="openComment()">
        <span>ğŸ§§</span> å‘é€ç¥ç¦
    </button>

    <div class="control-panel">
        <div>æ‚¬åœ/ç‚¹å‡»å¯ç‚¹èµ</div>
        <div id="status-text">è¿æ¥ä¸­...</div>
    </div>

    <div class="modal-overlay" id="modal-overlay" onclick="closeComment()"></div>
    <div class="modal-sheet" id="modal-sheet">
        <div class="modal-header">
            <span class="modal-title">å†™ä¸‹ä½ çš„é©¬å¹´æ„¿æœ›</span>
            <span class="close-btn" onclick="closeComment()">Ã—</span>
        </div>
        <div class="twikoo-container">
            <div id="tcomment"></div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const CONFIG = {
            // è¯·æ›¿æ¢ä¸ºä½ çš„ Twikoo ç¯å¢ƒ ID
            twikooEnvId: 'https://comment.biss.click', 
            
            // å»ºè®®ä½¿ç”¨å¹´ä»½+ä¸»é¢˜ä½œä¸ºè·¯å¾„ï¼ŒåŒºåˆ†ä¸åŒé¡µé¢çš„è¯„è®º
            targetPath: '2026-greeting', 

            baseSize: 22,      
            maxSize: 60,       
            trackHeight: 65,   
            minSpeed: 100,     
            maxSpeed: 180,     
            hotThreshold: 10   
        };

        const FALLBACK_DATA = [
            { text: "é©¬å¹´å¤§å‰ï¼", nick: "ç³»ç»Ÿ", like: 88 },
            { text: "èº«ä½“å¥åº·ï¼Œä¸‡äº‹å¦‚æ„", nick: "ç¦æ˜Ÿ", like: 66 },
            { text: "è´¢æºå¹¿è¿›", nick: "è´¢ç¥", like: 128 },
            { text: "ä»£ç  0 Error", nick: "Dev", like: 1024 },
            { text: "é¾™é©¬ç²¾ç¥", nick: "æˆè¯­å›", like: 20 },
            { text: "å‰ç¨‹ä¼¼é”¦", nick: "é”¦é²¤", like: 9 }
        ];

        // ================= æ ¸å¿ƒé€»è¾‘ =================
        let danmakuPool = [];      
        let priorityQueue = [];    
        let currentIds = new Set(); 
        let tracks = [];           
        let syncTimers = {};       

        function initTracks() {
            const h = window.innerHeight;
            const count = Math.floor(h / CONFIG.trackHeight);
            tracks = new Array(count).fill(0);
        }
        window.onresize = initTracks;

        async function fetchData(isBackground = false) {
            const statusEl = document.getElementById('status-text');
            let items = [];

            try {
                if (CONFIG.twikooEnvId && CONFIG.twikooEnvId.length > 10) {
                    const params = {
                        envId: CONFIG.twikooEnvId,
                        pageSize: 80, 
                        includeReply: false
                    };
                    if (CONFIG.targetPath) params.urls = [CONFIG.targetPath];

                    const res = await twikoo.getRecentComments(params);
                    
                    items = res.map(item => ({
                        id: item._id,
                        text: item.commentText.replace(/<[^>]+>/g, "").trim().substring(0, 35),
                        nick: item.nick || "ç½‘å‹",
                        like: item.vote || item.like || 0
                    })).filter(i => i.text);

                    if (isBackground) {
                        let newCount = 0;
                        items.forEach(item => {
                            if (!currentIds.has(item.id)) {
                                console.log(">> æ•æ‰åˆ°æ–°å¼¹å¹•:", item.text);
                                item.isNew = true; 
                                priorityQueue.push(item); 
                                currentIds.add(item.id);
                                newCount++;
                            }
                        });
                        statusEl.innerText = newCount > 0 ? `ä¸Šå¢™æˆåŠŸ! +${newCount}` : `åŒæ­¥å®Œæˆ`;
                        setTimeout(() => { statusEl.innerText = `åœ¨çº¿: ${items.length} æ¡`; }, 3000);
                    } else {
                        items.forEach(i => currentIds.add(i.id));
                        statusEl.innerText = `å·²åŠ è½½ ${items.length} æ¡ç¥ç¦`;
                    }
                }
            } catch (e) {
                console.log("åŠ è½½å¤±è´¥æˆ–ç¦»çº¿æ¨¡å¼", e);
                if (!isBackground) statusEl.innerText = "ç¦»çº¿æ¼”ç¤ºæ¨¡å¼";
            }

            if (items.length < 30) {
                while (items.length < 30) {
                    const fb = FALLBACK_DATA[Math.floor(Math.random() * FALLBACK_DATA.length)];
                    items.push({ ...fb, id: null, like: Math.floor(Math.random() * 50) });
                }
            }
            danmakuPool = items;
        }

        let isTwikooLoaded = false;
        function openComment() {
            document.getElementById('modal-overlay').classList.add('active');
            document.getElementById('modal-sheet').classList.add('active');

            if (!isTwikooLoaded) {
                twikoo.init({
                    envId: CONFIG.twikooEnvId,
                    el: '#tcomment',
                    path: CONFIG.targetPath || window.location.pathname, 
                    onCommentLoaded: function() {
                        console.log('Twikoo Ready');
                        const container = document.getElementById('tcomment');
                        container.addEventListener('click', (e) => {
                            const btn = e.target.closest('.tk-submit') || e.target.closest('.el-button--primary');
                            if (btn) {
                                document.getElementById('status-text').innerText = "å‘é€ä¸­...";
                                setTimeout(() => fetchData(true), 1500);
                            }
                        });
                    }
                });
                isTwikooLoaded = true;
            }
        }

        function closeComment() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.getElementById('modal-sheet').classList.remove('active');
            fetchData(true);
        }

        function createDanmaku() {
            const stage = document.getElementById('danmaku-stage');
            if (!danmakuPool.length && !priorityQueue.length) return;

            const now = Date.now();
            const validTracks = tracks
                .map((t, i) => ({ idx: i, freeTime: t }))
                .filter(item => now >= item.freeTime);

            if (validTracks.length === 0) return; 
            const trackIdx = validTracks[Math.floor(Math.random() * validTracks.length)].idx;

            let data;
            if (priorityQueue.length > 0) {
                data = priorityQueue.shift(); 
            } else {
                data = danmakuPool[Math.floor(Math.random() * danmakuPool.length)];
            }

            let fontSize = CONFIG.baseSize + (data.like / 4);
            if (fontSize > CONFIG.maxSize) fontSize = CONFIG.maxSize;

            const el = document.createElement('div');
            el.className = 'danmaku-item';
            
            if (data.like >= CONFIG.hotThreshold) el.classList.add('super-hot');
            if (data.isNew) el.classList.add('just-now'); 

            el.style.fontSize = `${fontSize}px`;
            el.style.top = `${trackIdx * CONFIG.trackHeight + 10}px`;

            el.innerHTML = `
                <span class="dm-text">${data.text}</span>
                <div class="dm-info">
                    <span class="nick-name">@${data.nick}</span>
                    <button class="like-btn">ğŸ‘ <span class="count">${data.like}</span></button>
                </div>
            `;
            stage.appendChild(el);

            const elWidth = el.offsetWidth;
            const screenW = window.innerWidth;
            const speed = Math.random() * (CONFIG.maxSpeed - CONFIG.minSpeed) + CONFIG.minSpeed;
            const duration = (screenW + elWidth + 50) / speed;

            el.style.animation = `flyLeft ${duration}s linear forwards`;
            el.addEventListener('animationend', () => el.remove());

            const safeGap = 60; 
            const timeToEnter = ((elWidth + safeGap) / speed) * 1000;
            tracks[trackIdx] = now + timeToEnter;

            const likeBtn = el.querySelector('.like-btn');
            el.querySelector('.dm-info').addEventListener('click', e => e.stopPropagation());
            likeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                data.like++;
                likeBtn.querySelector('.count').innerText = data.like;
                likeBtn.classList.add('liked');
                if (data.like >= CONFIG.hotThreshold) el.classList.add('super-hot');
                if (data.id) syncLike(data.id);
            });
        }

        function syncLike(cid) {
            if (syncTimers[cid]) clearTimeout(syncTimers[cid]);
            syncTimers[cid] = setTimeout(async () => {
                try {
                    await twikoo.linkComment({ id: cid, envId: CONFIG.twikooEnvId });
                } catch (e) {}
                delete syncTimers[cid];
            }, 2000);
        }

        async function start() {
            initTracks();
            await fetchData(false); 
            for(let i=0; i<8; i++) setTimeout(createDanmaku, i * 200);
            setInterval(() => {
                if (!document.hidden) createDanmaku();
            }, 500);
        }

        window.onload = start;
    </script>
</body>
</html>